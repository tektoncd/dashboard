/*
Copyright 2025 The Tekton Authors
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
		http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

package endpoints

import (
	"context"
	"fmt"
	"net/http"
	"strings"

	"github.com/tektoncd/dashboard/pkg/logging"
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
	"k8s.io/apimachinery/pkg/apis/meta/v1/unstructured"
)

const (
	// Real Tekton cat logo from tekton-logo-20x20.svg
	tektonLogoSVG = `<g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><path d="M4.17745095,12.7421271 C4.39445095,12.8131271 4.59045095,12.9221271 4.76145095,13.0701271 C4.79545095,13.0981271 4.81945095,13.1541271 4.82145095,13.1981271 C4.84645095,13.8151271 4.90745095,14.4271271 5.07445095,15.0241271 C5.10745095,15.1461271 5.16445095,15.2631271 5.22045095,15.3771271 C5.29245095,15.5231271 5.29545095,15.6731271 5.27545095,15.8281271 C5.26745095,15.8881271 5.22745095,15.8851271 5.18345095,15.8851271 C4.95945095,15.8891271 4.73445095,15.8961271 4.50945095,15.8971271 C4.12145095,15.8981271 3.73345095,15.8931271 3.34445095,15.8951271 C3.22445095,15.8961271 3.14145095,15.8451271 3.08645095,15.7431271 C2.97145095,15.5311271 2.93845095,15.3111271 3.06245095,15.0921271 C3.18345095,14.8771271 3.39445095,14.8111271 3.62145095,14.8181271 C3.80045095,14.8241271 3.96145095,14.9131271 4.09845095,15.0281271 C4.23545095,15.1421271 4.36145095,15.2711271 4.48745095,15.3881271 C4.46045095,15.0981271 4.32645095,14.8501271 4.05045095,14.7021271 C3.87945095,14.6111271 3.77445095,14.4781271 3.69345095,14.3061271 C3.48445095,13.8651271 3.31345095,13.4091271 3.17845095,12.9401271 C3.16145095,12.8771271 3.17745095,12.8481271 3.23045095,12.8181271 C3.53545095,12.6431271 3.85145095,12.6341271 4.17745095,12.7421271 Z M7.79395095,12.6746271 C7.97995095,12.6766271 8.15495095,12.7296271 8.31195095,12.8316271 C8.33495095,12.8466271 8.35595095,12.8956271 8.34895095,12.9216271 C8.20095095,13.4686271 8.00495095,13.9976271 7.73295095,14.4946271 C7.69395095,14.5636271 7.61195095,14.6176271 7.53895095,14.6586271 C7.26295095,14.8126271 7.08995095,15.0366271 7.04595095,15.3526271 C7.04395095,15.3656271 7.04195095,15.3796271 7.04195095,15.3916271 C7.04195095,15.3966271 7.04695095,15.4016271 7.04995095,15.4096271 C7.13295095,15.3196271 7.21295095,15.2276271 7.29895095,15.1416271 C7.43895095,15.0016271 7.60295095,14.8966271 7.79495095,14.8396271 C8.06595095,14.7586271 8.38795095,14.8936271 8.49295095,15.1426271 C8.59295095,15.3796271 8.54595095,15.6016271 8.39895095,15.8056271 C8.34995095,15.8746271 8.27695095,15.8926271 8.19595095,15.8926271 C7.69995095,15.8916271 7.20595095,15.8926271 6.71095095,15.8906271 C6.58895095,15.8906271 6.46695095,15.8846271 6.34595095,15.8866271 C6.28595095,15.8876271 6.25595095,15.8686271 6.25095095,15.8066271 C6.23895095,15.6386271 6.26495095,15.4846271 6.33795095,15.3236271 C6.43595095,15.1066271 6.49995095,14.8716271 6.54995095,14.6386271 C6.65295095,14.1596271 6.69595095,13.6736271 6.71095095,13.1846271 C6.71195095,13.1506271 6.72695095,13.1056271 6.75095095,13.0866271 C7.05295095,12.8356271 7.39095095,12.6696271 7.79395095,12.6746271 Z M1.54505095,12.9340271 C1.79005095,13.0340271 2.01705095,13.1210271 2.23805095,13.2190271 C2.44105095,13.3090271 2.63705095,13.4120271 2.83405095,13.5100271 C2.86105095,13.5240271 2.89305095,13.5450271 2.90305095,13.5720271 C3.01505095,13.8500271 3.12305095,14.1310271 3.23305095,14.4170271 C3.22205095,14.4220271 3.20605095,14.4310271 3.18905095,14.4380271 C2.81305095,14.5810271 2.59705095,14.8530271 2.54705095,15.2520271 C2.54005095,15.3090271 2.51905095,15.3290271 2.46205095,15.3290271 C1.93905095,15.3270271 1.41505095,15.3270271 0.892050948,15.3300271 C0.773050948,15.3300271 0.77405081,15.2410271 0.77405081,15.1690271 C0.779050948,14.8890271 0.897050948,14.6660271 1.14105095,14.5230271 C1.37805095,14.3820271 1.63805095,14.3780271 1.89705095,14.4370271 C2.09205095,14.4820271 2.28205095,14.5470271 2.49205095,14.6090271 C1.90905095,14.2050271 1.51805095,13.7050271 1.54505095,12.9340271 Z M9.98055095,12.9585271 C10.0035509,13.7025271 9.61755095,14.2075271 9.02555095,14.6135271 C9.24455095,14.5505271 9.43555095,14.4865271 9.62955095,14.4395271 C9.84155095,14.3885271 10.0565509,14.3895271 10.2655509,14.4655271 C10.5795509,14.5805271 10.7915509,14.9185271 10.7455509,15.2205271 C10.7335509,15.2965271 10.7035509,15.3275271 10.6205509,15.3265505 C10.0965509,15.3235271 9.57355095,15.3245271 9.04955095,15.3255271 C9.00155095,15.3255271 8.95955095,15.3305271 8.95055095,15.2575271 C8.90055095,14.8515271 8.67355095,14.5855271 8.28855095,14.4525271 C8.27455095,14.4475271 8.26055095,14.4415271 8.25255095,14.4375271 C8.35755095,14.1575271 8.45955095,13.8825271 8.56455095,13.6065271 C8.57255095,13.5855271 8.59455095,13.5635271 8.61555095,13.5545271 C9.03855095,13.3625271 9.46055095,13.1715271 9.88455095,12.9815271 C9.91355095,12.9695271 9.94555095,12.9665271 9.98055095,12.9585271 Z M6.29065095,13.2690271 C6.28465095,13.4130271 6.28865095,13.5700271 6.26465095,13.7240271 C6.20665095,14.1080271 6.13765095,14.4890271 6.07165095,14.8720271 C6.06465095,14.9090271 6.04965095,14.9450271 6.03765095,14.9820271 C5.96465095,15.1970271 5.88465095,15.2430271 5.66465095,15.1940271 C5.64165095,15.1890271 5.61365095,15.1640271 5.60565095,15.1410271 C5.54465095,14.9700271 5.47465095,14.8000271 5.43265095,14.6240271 C5.32665095,14.1800271 5.28065095,13.7270271 5.26965095,13.2690271 L6.29065095,13.2690271 Z M9.08605095,11.5014271 C9.41505095,11.5884271 9.80805095,12.1914271 9.79905095,12.6044271 C9.46305095,12.7464271 9.13105095,12.8884271 8.81105095,13.0244271 C8.90105095,12.5234271 8.99305095,12.0124271 9.08605095,11.5014271 Z M2.44385095,11.5009271 C2.53585095,12.0149271 2.62785095,12.5269271 2.71785095,13.0249271 C2.41185095,12.8999271 2.09485095,12.7709271 1.77985095,12.6389271 C1.75985095,12.6309271 1.73585095,12.5969271 1.73885095,12.5799271 C1.81185095,12.1289271 1.99985095,11.7509271 2.41185095,11.5129271 C2.42485095,11.5049271 2.44085095,11.5019271 2.44385095,11.5009271 Z M3.44635095,8.80162708 C3.59235095,8.85362708 3.74335095,8.89362708 3.88135095,8.96362708 C4.55635095,9.30262708 5.27035095,9.47262708 6.02735095,9.44262708 C6.65835095,9.41862708 7.25535095,9.25762708 7.82035095,8.97462708 C7.96335095,8.90462708 8.11835095,8.86062708 8.26735095,8.80562708 C8.27235095,8.81162708 8.27735095,8.81962708 8.28335095,8.82662708 C8.11935095,9.04262708 7.93235095,9.23762708 7.70335095,9.38162708 C7.47635095,9.52262708 7.23435095,9.64162708 7.03735095,9.75062708 C7.25635095,9.74762708 7.74135095,9.60162708 8.34735095,9.34362708 C8.66935095,9.80562708 8.74835095,11.6076271 8.47935095,12.3566271 C7.90435095,12.1116271 7.37635095,12.2886271 6.85635095,12.5376271 C6.80535095,12.5616271 6.75635095,12.5906271 6.70835095,12.6156271 C6.66335095,12.2876271 6.63335095,11.9686271 6.57135095,11.6536271 C6.50535095,11.3106271 6.41035095,10.9736271 6.32535095,10.6356271 C6.31335095,10.5906271 6.29035095,10.5446271 6.26235095,10.5076271 C6.20735095,10.4336271 6.10235095,10.4136271 6.02835095,10.4576271 C5.95235095,10.5026271 5.92335095,10.5686271 5.93935095,10.6606271 C6.01935095,11.0966271 6.10335095,11.5306271 6.17035095,11.9686271 C6.21735095,12.2676271 6.23835095,12.5726271 6.27135095,12.8876271 C5.93235095,12.9376271 5.61135095,12.9356271 5.27035095,12.8986271 C5.28335095,12.7346271 5.28635095,12.5716271 5.31035095,12.4116271 C5.39335095,11.8476271 5.48335095,11.2826271 5.57035095,10.7186271 C5.57435095,10.6966271 5.57735095,10.6746271 5.57735095,10.6516271 C5.58135095,10.5326271 5.54335095,10.4716271 5.45635095,10.4486271 C5.35835095,10.4246271 5.27335095,10.4596271 5.23635095,10.5696271 C5.16735095,10.7726271 5.09835095,10.9776271 5.05735095,11.1876271 C4.96835095,11.6506271 4.89535095,12.1166271 4.81435095,12.5876271 C4.27935095,12.2066271 3.69335095,12.0726271 3.05035095,12.3946271 C2.83635095,11.3046271 2.77335095,10.2416271 3.22935095,9.19262708 C3.64335095,9.46462708 4.09335095,9.61462708 4.56935095,9.69562708 C4.11535095,9.50162708 3.73535095,9.21562708 3.43435095,8.82562708 C3.43835095,8.81662708 3.44235095,8.80862708 3.44635095,8.80162708 Z M9.88875095,10.3198271 C10.1017509,10.6358271 10.2337509,10.7378271 10.5537509,10.8478271 C10.3597509,11.1658271 10.1627509,11.4828271 9.96275095,11.8078271 C9.82175095,11.5608271 9.63475095,11.3538271 9.37075095,11.1898271 C9.54275095,10.9018271 9.71175095,10.6178271 9.88875095,10.3198271 Z M14.0079509,9.11082708 C14.0899509,9.15482708 14.1789509,9.18082708 14.2389509,9.23882708 C14.5429509,9.53182708 14.7569509,9.88082708 14.8489509,10.2978271 C14.9009509,10.5308271 14.8329509,10.7178271 14.6579509,10.8688271 C14.4679509,11.0328271 14.2479509,11.1178271 13.9919509,11.0758271 C13.8349509,11.0498271 13.7199509,10.9648271 13.6499509,10.8228271 C13.6019509,10.7258271 13.5699509,10.6198271 13.5179509,10.5238271 C13.4389509,10.3788271 13.3479509,10.2388271 13.2639509,10.0958271 C13.2509509,10.0758271 13.2329509,10.0518271 13.2349509,10.0318271 C13.2559509,9.70282708 13.3819509,9.42582708 13.6659509,9.24482708 C13.7619509,9.18282708 13.8819509,9.15882708 14.0079509,9.11082708 Z M10.7539509,9.37182708 C10.8209509,9.67682708 10.9619509,9.92682708 11.2129509,10.1128271 C11.0839509,10.2508271 10.9629509,10.3828271 10.8389509,10.5118271 C10.8259509,10.5258271 10.8029509,10.5378271 10.7829509,10.5388271 C10.5259509,10.5478271 10.2599509,10.3678271 10.1659509,10.1268271 C10.1379509,10.0538271 10.1409509,9.99582708 10.1989509,9.93482708 C10.3569509,9.77482708 10.5089509,9.60982708 10.6629509,9.44782708 C10.6879509,9.42282708 10.7169509,9.40282708 10.7539509,9.37182708 Z M11.9424509,8.65872708 C11.8314509,9.20272708 11.8344509,9.25472708 11.9894509,9.69372708 C11.8384509,9.76072708 11.6864509,9.82672708 11.5354509,9.89072708 C11.5184509,9.89772708 11.4924509,9.88772708 11.4724509,9.87972708 C11.2634509,9.78572708 11.0614509,9.46072708 11.0714509,9.22972708 C11.0744509,9.14872708 11.1034509,9.08672708 11.1774509,9.03872708 C11.4164509,8.88572708 11.6634509,8.75472708 11.9424509,8.65872708 Z M12.6578509,8.52502708 C13.0448509,8.52902708 13.3958509,8.63802708 13.7438509,8.84402708 C13.5128509,8.92402708 13.3358509,9.05502708 13.1948509,9.23202708 C13.0548509,9.40802708 12.9718509,9.61102708 12.9278509,9.81202708 C12.7488509,9.76802708 12.5788509,9.72702708 12.4088509,9.68402708 C12.3908509,9.67902708 12.3678509,9.66702708 12.3578509,9.65202708 C12.1788509,9.38202708 12.1338509,9.09402708 12.2578509,8.79102708 C12.3288509,8.61802708 12.4538509,8.52302708 12.6578509,8.52502708 Z M6.56645095,8.23612708 C6.62545095,8.24912708 6.68345095,8.27012708 6.73745095,8.29712708 C6.87445095,8.36612708 6.89145095,8.46512708 6.76945095,8.55612708 C6.67345095,8.62512708 6.55845095,8.68512708 6.44445095,8.70712708 C6.25345095,8.74612708 6.05545095,8.74912708 5.86045095,8.76712708 C5.66245095,8.74912708 5.46145095,8.74612708 5.26745095,8.70612708 C5.14845095,8.68212708 5.03045095,8.61312708 4.93145095,8.53812708 C4.82745095,8.45812708 4.84245095,8.35412708 4.96745095,8.30812708 C5.11545095,8.25312708 5.27245095,8.21112708 5.42945095,8.19112708 C5.80945095,8.14112708 6.19045095,8.14812708 6.56645095,8.23612708 Z M1.33505095,6.58302708 C1.49205095,6.63402708 1.64905095,6.68702708 1.80805095,6.73502708 C2.47105095,6.93802708 3.14705095,7.08102708 3.83605095,7.15502708 C3.91005095,7.16302708 3.96005095,7.18702708 4.00005095,7.26002708 C4.16605095,7.56402708 4.43305095,7.75302708 4.74405095,7.88502708 C4.78305095,7.90102708 4.82105095,7.91602708 4.85905095,7.93202708 C4.86205095,7.93402708 4.86305095,7.93702708 4.87405095,7.94902708 C4.61105095,8.07602708 4.45405095,8.26402708 4.53805095,8.59502708 C3.96605095,8.48702708 3.43305095,8.31002708 2.93105095,8.04202708 C2.27605095,7.69402708 1.73505095,7.21902708 1.31905095,6.60602708 C1.32405095,6.59802708 1.32905095,6.59102708 1.33505095,6.58302708 Z M10.3819509,6.59322708 C9.59495095,7.71522708 8.51695095,8.33722708 7.18995095,8.58822708 C7.26495095,8.27622708 7.12695095,8.07722708 6.84095095,7.94522708 C6.93995095,7.90122708 7.02295095,7.86622708 7.10395095,7.82622708 C7.37795095,7.69122708 7.60395095,7.50122708 7.74395095,7.22422708 C7.78095095,7.15122708 7.84595095,7.16822708 7.90195095,7.15822708 C8.27995095,7.09422708 8.66395095,7.05122708 9.03795095,6.96622708 C9.46195095,6.86922708 9.87695095,6.73522708 10.2959509,6.61622708 C10.3199509,6.61022708 10.3439509,6.60322708 10.3819509,6.59322708 Z M6.89345095,5.90262708 C6.99845095,5.95062708 7.09745095,6.01262708 7.19145095,6.07862708 C7.58345095,6.35362708 7.57045095,6.81962708 7.37645095,7.11262708 C7.15645095,7.44362708 6.83345095,7.60562708 6.43545095,7.60062708 C6.22545095,7.59862708 6.07445095,7.48362708 5.97345095,7.30262708 C5.93945095,7.24262708 5.90645095,7.18162708 5.86345095,7.10262708 C5.82445095,7.16462708 5.79545095,7.20862708 5.76745095,7.25362708 C5.55745095,7.60762708 5.25745095,7.71262708 4.88345095,7.53962708 C4.72645095,7.46762708 4.57445095,7.36762708 4.44645095,7.25062708 C4.14745095,6.97662708 4.06645095,6.37262708 4.55145095,6.05062708 C4.83645095,5.86062708 5.14945095,5.75762708 5.48245095,5.71162708 C5.96945095,5.64362708 6.44345095,5.69962708 6.89345095,5.90262708 Z M5.53745095,5.95662708 C5.35545095,5.98062708 5.17645095,6.02162708 5.02145095,6.12662708 C4.87045095,6.22962708 4.82245095,6.41462708 4.92745095,6.56462708 C4.99045095,6.65262708 5.08145095,6.73062708 5.17545095,6.78462708 C5.38445095,6.90562708 5.61945095,6.94862708 5.86145095,6.95362708 C5.95645095,6.94262708 6.05345095,6.93862708 6.14745095,6.92062708 C6.36045095,6.87962708 6.56545095,6.81562708 6.72445095,6.65662708 C6.91245095,6.46662708 6.87845095,6.22562708 6.64745095,6.09562708 C6.61145095,6.07562708 6.57345095,6.05762708 6.53445095,6.04262708 C6.21045095,5.92562708 5.87545095,5.91162708 5.53745095,5.95662708 Z M5.7350673,0.327327076 C5.73305095,0.905327076 5.73405095,1.48432708 5.73405095,2.06232708 C5.73405095,2.07432708 5.73105095,2.08732708 5.72805095,2.11132708 C5.28005095,2.13232708 4.84605095,2.18432708 4.42005095,2.30132708 C3.14605095,2.64932708 2.44005095,3.52832708 2.11605095,4.76232708 C2.08305095,4.88632708 2.08705095,5.02332708 2.09205095,5.15332708 C2.09805095,5.31132708 2.19105095,5.42832708 2.30405095,5.52932708 C2.53405095,5.73432708 2.81405095,5.85032708 3.10505095,5.93432708 C3.38405095,6.01632708 3.66805095,6.07932708 3.96605095,6.15432708 C3.84505095,6.38432708 3.84205095,6.64132708 3.86405095,6.91432708 C3.65305095,6.88432708 3.45705095,6.86132708 3.26205095,6.82932708 C2.57005095,6.71632708 1.89805095,6.53132708 1.24105095,6.28932708 C1.12905095,6.24832708 1.08205095,6.17932708 1.07605095,6.07232708 C0.999050948,4.57232708 1.30605095,3.17932708 2.26305095,1.98432708 C2.98205095,1.08532708 3.91805095,0.529327076 5.05505095,0.325327076 C5.24705095,0.291327076 5.44205095,0.276327076 5.63705095,0.253327076 C5.69105095,0.246327076 5.73605095,0.247327076 5.7350673,0.327327076 Z M6.07765095,0.251827076 C7.17165095,0.321827076 8.13665095,0.707827076 8.95165095,1.44782708 C9.76765095,2.19082708 10.2536509,3.12182708 10.4936509,4.18982708 C10.6226509,4.76682708 10.6696509,5.34982708 10.6456509,5.94082708 C10.6346509,6.21582708 10.6356509,6.21582708 10.3816509,6.30982708 C9.58365095,6.60582708 8.76165095,6.79882708 7.91565095,6.89682708 C7.90465095,6.89782708 7.89165095,6.89782708 7.86165095,6.89982708 C7.87865095,6.63682708 7.88465095,6.38382708 7.74965095,6.15082708 C7.98365095,6.09782708 8.20665095,6.05182708 8.42465095,5.99582708 C8.71465095,5.92182708 8.99365095,5.81682708 9.25065095,5.66082708 C9.58265095,5.46082708 9.70765095,5.17482708 9.61765095,4.80082708 C9.39765095,3.89182708 8.94665095,3.13782708 8.12765095,2.64382708 C7.71365095,2.39382708 7.25265095,2.26482708 6.77865095,2.19082708 C6.53865095,2.15282708 6.29365095,2.13482708 6.05165095,2.11382708 C5.99365095,2.10882708 5.97465095,2.08982708 5.97465095,2.03382708 C5.97565095,1.46782708 5.97665095,0.901827076 5.97465095,0.336827076 C5.97465095,0.257827076 6.01365095,0.246827076 6.07765095,0.251827076 Z M4.36745095,4.32652708 C4.57645095,4.51352708 4.67345095,4.75452708 4.69246389,4.99652708 C4.69345095,5.16352708 4.63645095,5.23952708 4.53445095,5.24252708 C4.43645095,5.24552708 4.37345095,5.17552708 4.35945095,5.05152708 L4.35345095,4.96552708 L4.35345095,4.96552708 C4.32345095,4.76752708 4.23245095,4.60752708 4.05545095,4.50552708 C3.83945095,4.38152708 3.57645095,4.45152708 3.42145095,4.66952708 C3.39945095,4.70152708 3.38245095,4.73552708 3.36245095,4.76852708 C3.30845095,4.85952708 3.22545095,4.88852708 3.14345095,4.84552708 C3.06345095,4.80352708 3.03245095,4.71252708 3.07545095,4.62252708 C3.33545095,4.08752708 3.95445095,3.95652708 4.36745095,4.32652708 Z M7.85945095,4.12112708 C8.20045095,4.11912708 8.52545095,4.33812708 8.64345095,4.63412708 C8.67645095,4.71812708 8.64345095,4.80812708 8.56545095,4.84412708 C8.48545095,4.88112708 8.40345095,4.85312708 8.35645095,4.76412708 C8.28145095,4.62212708 8.17945095,4.51112708 8.02345095,4.46312708 C7.74445095,4.37712708 7.45445095,4.56412708 7.37445095,4.88112708 C7.35945095,4.94012708 7.35545095,5.00112708 7.35045095,5.06112708 C7.34145095,5.16912708 7.27845095,5.23812708 7.18445095,5.23812708 C7.08845095,5.23712708 7.03145095,5.17112708 7.02945095,5.05812708 C7.02245095,4.62412708 7.32245095,4.22812708 7.72845095,4.13712708 C7.77845095,4.12512708 7.83045095,4.12412708 7.85945095,4.12112708 Z M0.278250948,0.0378270758 C0.699250948,0.288827076 1.03225095,0.634827076 1.32425095,1.02182708 C1.48025095,1.22882708 1.61725095,1.45082708 1.76525095,1.66482708 C1.79325095,1.70582708 1.79325095,1.73582708 1.76225095,1.77582708 C1.36825095,2.28282708 1.08425095,2.84682708 0.882250948,3.45482708 C0.878250948,3.46982708 0.870250948,3.48382708 0.863250948,3.49782708 C0.851250948,3.50182708 0.841250948,3.50582708 0.829250948,3.50882708 C0.696250948,3.28282708 0.553250948,3.06282708 0.433250948,2.83082708 C0.150250948,2.27982708 0.00725094844,1.69182708 0.000250948444,1.07282708 C-0.00374905156,0.744827076 0.0402509484,0.420827076 0.119250948,0.101827076 C0.147250948,-0.0131729242 0.174250948,-0.0251729242 0.278250948,0.0378270758 Z M11.5894509,0.0839270758 C11.6874509,0.504927076 11.7324509,0.929927076 11.6954509,1.36392708 C11.6304509,2.12192708 11.3584509,2.80092708 10.9244509,3.42092708 C10.9074509,3.44692708 10.8864509,3.47092708 10.8624509,3.50192708 C10.7644509,3.26192708 10.6794509,3.03392708 10.5804509,2.81192708 C10.4174509,2.44692708 10.2094509,2.10792708 9.96745095,1.78992708 C9.94045095,1.75292708 9.91545095,1.72292708 9.94645095,1.67092708 C10.2944509,1.11092708 10.6824509,0.585927076 11.2164509,0.186927076 C11.2944509,0.128927076 11.3754509,0.0769270758 11.4584509,0.0279270758 C11.5354509,-0.0170729242 11.5684509,-0.00207292424 11.5894509,0.0839270758 Z M5.38505095,1.45532708 C5.30505095,1.45332708 5.23605095,1.51532708 5.23205095,1.59432708 C5.22905095,1.67532708 5.29905095,1.75032708 5.38005095,1.75132708 C5.45605095,1.75132708 5.52605095,1.68132708 5.52805095,1.60532708 C5.52905095,1.52632708 5.46505095,1.45832708 5.38505095,1.45532708 Z M6.34265095,1.45582708 C6.26065095,1.45182708 6.19765095,1.50982708 6.19465095,1.59482708 C6.19165095,1.67882708 6.24965095,1.74582708 6.32865095,1.75082708 C6.40465095,1.75482708 6.47565095,1.68882708 6.47765095,1.60882708 C6.48065095,1.52582708 6.42265095,1.45982708 6.34265095,1.45582708 Z M1.10975095,0.154427076 C1.66375095,0.293427076 2.15875095,0.553427076 2.64075095,0.858427076 C2.44775095,1.03942708 2.26375095,1.21142708 2.07275095,1.38942708 C1.78775095,0.946427076 1.48275095,0.525427076 1.10975095,0.154427076 Z M10.6202509,0.136227076 C10.4322509,0.353227076 10.2552509,0.543227076 10.0952509,0.747227076 C9.93425095,0.950227076 9.79225095,1.16822708 9.63825095,1.38522708 C9.45225095,1.21122708 9.26625095,1.03822708 9.07325095,0.857227076 C9.55725095,0.552227076 10.0532509,0.293227076 10.6202509,0.136227076 Z M5.37705095,0.778327076 C5.29205095,0.778327076 5.23105095,0.840327076 5.23205095,0.923327076 C5.23505095,1.00532708 5.30005095,1.06632708 5.38305095,1.06432708 C5.46605095,1.06232708 5.53005095,0.998327076 5.52805095,0.917327076 C5.52605095,0.838327076 5.46105095,0.778327076 5.37705095,0.778327076 Z M6.33365095,0.778827076 C6.24765095,0.778827076 6.19365095,0.835827076 6.19465095,0.925827076 C6.19665095,1.00982708 6.24865095,1.06282708 6.33265095,1.06382708 C6.41965095,1.06582708 6.47865095,1.00782708 6.47865095,0.921827076 C6.47865095,0.835827076 6.41965095,0.777827076 6.33365095,0.778827076 Z" fill="#FFF"></path></g>`

	// Tekton brand colors
	colorSuccess      = "#24a148"
	colorError        = "#da1e28"
	colorInfo         = "#0f62fe"
	colorWarning      = "#f1c21b"
	colorGray         = "#525252"
	colorTektonPurple = "#6f42c1" // Tekton purple
)

type PipelineStatus struct {
	Status string
	Reason string
	Color  string
	Icon   string
	Label  string
}

// GetPipelineStatus determines the status of a pipeline based on the latest PipelineRun
func (r Resource) getPipelineStatus(namespace, pipeline string) (*PipelineStatus, error) {
	// List PipelineRuns for this pipeline
	listOptions := metav1.ListOptions{
		LabelSelector: fmt.Sprintf("tekton.dev/pipeline=%s", pipeline),
	}

	// Create REST client for Tekton API
	client := r.K8sClient.Discovery().RESTClient()

	// Use the RESTClient to list PipelineRuns
	result := &unstructured.UnstructuredList{}
	err := client.Get().
		AbsPath("/apis/tekton.dev/v1/namespaces/"+namespace+"/pipelineruns").
		VersionedParams(&listOptions, metav1.ParameterCodec).
		Do(context.TODO()).
		Into(result)

	if err != nil {
		logging.Log.Debugf("Error listing PipelineRuns: %s", err.Error())
		return &PipelineStatus{
			Status: "Unknown",
			Reason: "NotFound",
			Color:  colorGray,
			Icon:   getStatusIcon("unknown"),
			Label:  "No runs",
		}, nil
	}

	if len(result.Items) == 0 {
		return &PipelineStatus{
			Status: "Unknown",
			Reason: "NotFound",
			Color:  colorGray,
			Icon:   getStatusIcon("unknown"),
			Label:  "No runs",
		}, nil
	}

	// Get the most recent PipelineRun (they should be sorted by creation time)
	latestRun := result.Items[0]
	for _, run := range result.Items {
		runTime, _, _ := unstructured.NestedString(run.Object, "metadata", "creationTimestamp")
		latestTime, _, _ := unstructured.NestedString(latestRun.Object, "metadata", "creationTimestamp")
		if runTime > latestTime {
			latestRun = run
		}
	}

	// Extract status conditions
	conditions, found, err := unstructured.NestedSlice(latestRun.Object, "status", "conditions")
	if err != nil || !found || len(conditions) == 0 {
		return &PipelineStatus{
			Status: "Unknown",
			Reason: "Pending",
			Color:  colorGray,
			Icon:   getStatusIcon("pending"),
			Label:  "Pending",
		}, nil
	}

	// Find the Succeeded condition
	var succeededCondition map[string]interface{}
	for _, cond := range conditions {
		if condMap, ok := cond.(map[string]interface{}); ok {
			if condType, ok := condMap["type"].(string); ok && condType == "Succeeded" {
				succeededCondition = condMap
				break
			}
		}
	}

	if succeededCondition == nil {
		return &PipelineStatus{
			Status: "Unknown",
			Reason: "Unknown",
			Color:  colorGray,
			Icon:   getStatusIcon("unknown"),
			Label:  "Unknown",
		}, nil
	}

	status := succeededCondition["status"].(string)
	reason := succeededCondition["reason"].(string)

	return parsePipelineStatus(status, reason), nil
}

func parsePipelineStatus(status, reason string) *PipelineStatus {
	switch status {
	case "True":
		// Check for warnings
		if strings.Contains(strings.ToLower(reason), "warning") || strings.Contains(strings.ToLower(reason), "completed") {
			return &PipelineStatus{
				Status: status,
				Reason: reason,
				Color:  colorWarning,
				Icon:   getStatusIcon("success-warning"),
				Label:  "Warning",
			}
		}
		return &PipelineStatus{
			Status: status,
			Reason: reason,
			Color:  colorSuccess,
			Icon:   getStatusIcon("success"),
			Label:  "Succeeded",
		}
	case "False":
		return &PipelineStatus{
			Status: status,
			Reason: reason,
			Color:  colorError,
			Icon:   getStatusIcon("failed"),
			Label:  "Failed",
		}
	case "Unknown":
		// Check reason for more specific status
		reasonLower := strings.ToLower(reason)
		if strings.Contains(reasonLower, "running") || strings.Contains(reasonLower, "progress") {
			return &PipelineStatus{
				Status: status,
				Reason: reason,
				Color:  colorInfo,
				Icon:   getStatusIcon("running"),
				Label:  "Running",
			}
		}
		if strings.Contains(reasonLower, "pending") {
			return &PipelineStatus{
				Status: status,
				Reason: reason,
				Color:  colorGray,
				Icon:   getStatusIcon("pending"),
				Label:  "Pending",
			}
		}
		return &PipelineStatus{
			Status: status,
			Reason: reason,
			Color:  colorGray,
			Icon:   getStatusIcon("unknown"),
			Label:  "Unknown",
		}
	default:
		return &PipelineStatus{
			Status: status,
			Reason: reason,
			Color:  colorGray,
			Icon:   getStatusIcon("unknown"),
			Label:  "Unknown",
		}
	}
}

func getStatusIcon(status string) string {
	switch status {
	case "success":
		// Checkmark filled icon
		return `<circle cx="10" cy="10" r="9" fill="currentColor"/><path d="M7.5 10l1.5 1.5 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>`
	case "success-warning":
		// Warning triangle with exclamation mark
		return `<path d="M10 2 L18 16 L2 16 Z" fill="currentColor"/><path d="M10 7 L10 11" stroke="white" stroke-width="1.5" stroke-linecap="round"/><circle cx="10" cy="13.5" r="0.75" fill="white"/>`
	case "failed":
		// X in circle (Misuse icon style)
		return `<circle cx="10" cy="10" r="9" fill="currentColor"/><path d="M7 7l6 6m0-6l-6 6" stroke="white" stroke-width="2" stroke-linecap="round"/>`
	case "running":
		// Spinning circle segments
		return `<circle cx="10" cy="10" r="8" fill="none" stroke="currentColor" stroke-width="2" opacity="0.3"/><path d="M10 2 A8 8 0 0 1 18 10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>`
	case "pending":
		// Clock/timer icon
		return `<circle cx="10" cy="10" r="8" fill="none" stroke="currentColor" stroke-width="2"/><path d="M10 6v4l3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"/>`
	case "unknown":
		// Question mark
		return `<circle cx="10" cy="10" r="8" fill="none" stroke="currentColor" stroke-width="2"/><text x="10" y="14" font-size="10" fill="currentColor" text-anchor="middle" font-weight="bold">?</text>`
	default:
		return `<circle cx="10" cy="10" r="8" fill="currentColor" opacity="0.3"/>`
	}
}

func generateBadgeSVG(pipeline string, status *PipelineStatus) string {
	// Compact width calculation (5px per character)
	pipelineTextWidth := len(pipeline) * 5
	statusTextWidth := len(status.Label) * 5

	// Add padding for icons and spacing
	leftWidth := pipelineTextWidth + 48 // 20px logo + 28px padding
	rightWidth := statusTextWidth + 48  // 20px icon + 28px padding

	// Minimum widths
	if leftWidth < 70 {
		leftWidth = 70
	}
	if rightWidth < 70 {
		rightWidth = 70
	}

	totalWidth := leftWidth + rightWidth
	height := 28

	// Calculate positions - better vertical centering
	logoX := 6
	logoY := 6
	pipelineTextX := leftWidth/2 + 14
	statusIconX := leftWidth + 6
	statusIconY := 5 // Adjusted for better vertical centering
	statusTextX := leftWidth + rightWidth/2 + 14

	// Generate SVG
	svg := fmt.Sprintf(`<svg xmlns="http://www.w3.org/2000/svg" width="%d" height="%d" role="img" aria-label="%s: %s">
  <title>%s: %s</title>
  <defs>
    <linearGradient id="shine" x2="0" y2="100%%">
      <stop offset="0" stop-color="#fff" stop-opacity=".15"/>
      <stop offset="1" stop-opacity=".15"/>
    </linearGradient>
    <clipPath id="round">
      <rect width="%d" height="%d" rx="5" fill="#fff"/>
    </clipPath>
  </defs>
  <g clip-path="url(#round)">
    <!-- Left section: Tekton purple with logo -->
    <rect width="%d" height="%d" fill="%s"/>
    <!-- Right section: Status color with icon -->
    <rect x="%d" width="%d" height="%d" fill="%s"/>
    <!-- Shine overlay -->
    <rect width="%d" height="%d" fill="url(#shine)"/>
  </g>
  <!-- Tekton logo (left) -->
  <svg x="%d" y="%d" width="16" height="16" viewBox="0 0 15 16">
    %s
  </svg>
  <!-- Pipeline name text -->
  <text x="%d" y="18" fill="#fff" font-family="Verdana,Geneva,DejaVu Sans,sans-serif" font-size="11" text-anchor="middle" text-rendering="geometricPrecision">%s</text>
  <!-- Status icon background (white circle for visibility) -->
  <circle cx="%d" cy="14" r="10" fill="#fff" opacity="0.95"/>
  <!-- Status icon -->
  <g color="%s">
    <svg x="%d" y="%d" width="18" height="18" viewBox="0 0 20 20">
      %s
    </svg>
  </g>
  <!-- Status text -->
  <text x="%d" y="18" fill="#fff" font-family="Verdana,Geneva,DejaVu Sans,sans-serif" font-size="11" text-anchor="middle" text-rendering="geometricPrecision">%s</text>
</svg>`,
		totalWidth, height,
		pipeline, status.Label,
		pipeline, status.Label,
		totalWidth, height,
		leftWidth, height, colorTektonPurple,
		leftWidth, rightWidth, height, status.Color,
		totalWidth, height,
		logoX, logoY,
		tektonLogoSVG,
		pipelineTextX, pipeline,
		statusIconX+9,
		status.Color,
		statusIconX, statusIconY,
		status.Icon,
		statusTextX, status.Label,
	)

	return svg
}

// GetPipelineBadge handles HTTP requests for pipeline status badges
func (r Resource) GetPipelineBadge(w http.ResponseWriter, req *http.Request) {
	// Parse URL path: /v1/badges/:namespace/:pipeline
	pathParts := strings.Split(strings.Trim(req.URL.Path, "/"), "/")
	if len(pathParts) < 4 {
		http.Error(w, "Invalid badge URL. Expected: /v1/badges/:namespace/:pipeline", http.StatusBadRequest)
		return
	}

	namespace := pathParts[2]
	pipeline := pathParts[3]

	// Get query parameters for customization
	query := req.URL.Query()
	style := query.Get("style") // future: support different styles
	_ = style                   // unused for now

	// Get pipeline status
	status, err := r.getPipelineStatus(namespace, pipeline)
	if err != nil {
		logging.Log.Errorf("Error getting pipeline status: %s", err.Error())
		// Return a gray "error" badge
		status = &PipelineStatus{
			Status: "Unknown",
			Reason: "Error",
			Color:  colorGray,
			Icon:   getStatusIcon("unknown"),
			Label:  "Error",
		}
	}

	// Generate SVG badge
	svg := generateBadgeSVG(pipeline, status)

	// Set headers
	w.Header().Set("Content-Type", "image/svg+xml; charset=utf-8")
	w.Header().Set("Cache-Control", "no-cache, no-store, must-revalidate")
	w.Header().Set("Expires", "0")

	// Write SVG
	w.WriteHeader(http.StatusOK)
	w.Write([]byte(svg))
}
